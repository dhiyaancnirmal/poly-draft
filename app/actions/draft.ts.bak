'use server'
import { createClient } from '@/lib/supabase/server'
import { revalidatePath } from 'next/cache'

export async function startDraft(leagueId: string) {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) throw new Error('Not authenticated')

  // 1. Verify user is league creator
  // @ts-ignore
  const { data: league, error: leagueError } = await supabase
    .from('leagues')
    .select('creator_id, status')
    .eq('id', leagueId)
    .single()

  if (leagueError || !league) throw new Error('League not found')
  if (league.creator_id !== user.id) throw new Error('Only creator can start draft')
  if (league.status !== 'open') throw new Error('Draft already started')

  // 2. Get members and shuffle for draft order
  // @ts-ignore
  const { data: members, error: membersError } = await supabase
    .from('league_members')
    .select('*')
    .eq('league_id', leagueId)
    .order('joined_at', { ascending: true })

  if (membersError || !members || members.length < 2) {
    throw new Error('Need at least 2 members to start draft')
  }

  // Fisher-Yates shuffle
  const shuffled = [...members]
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1))
    // @ts-ignore
    ;[shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]]
  }

  // 3. Assign draft_order to members
  for (let i = 0; i < shuffled.length; i++) {
    // @ts-ignore
    const { error: updateError } = await supabase
      .from('league_members')
      .update({ draft_order: i + 1 })
      .eq('id', shuffled[i].id)
    
    if (updateError) throw new Error('Failed to update draft order')
  }

  // 4. Update league status
  // @ts-ignore
  const { error: updateLeagueError } = await supabase
    .from('leagues')
    .update({
      status: 'drafting',
      draft_started_at: new Date().toISOString()
    })
    .eq('id', leagueId)

  if (updateLeagueError) throw new Error('Failed to update league status')

  // 5. Create draft_state
  // @ts-ignore
  const { error: insertError } = await supabase
    .from('draft_state')
    .insert({
      league_id: leagueId,
      current_pick_number: 1,
      current_round: 1,
      current_user_id: shuffled[0].user_id,
      picks_per_round: shuffled.length,
      draft_type: 'snake',
      is_paused: false,
      is_completed: false
    })

  if (insertError) throw new Error('Failed to create draft state')

  revalidatePath('/app/leagues')
  revalidatePath(`/app/draft/${leagueId}`)

  return { success: true }
}